
# FHQ Treap详解

## 1. 引言

Treap（Tree + Heap）是一种结合了二叉搜索树（BST）和堆特性的数据结构。FHQ Treap是其一个重要变体，由范浩强提出，通过分裂(split)和合并(merge)操作来维护树的平衡，无需传统Treap中的旋转操作。

## 2. 数据结构定义

### 2.1 节点结构

每个节点包含以下信息：

- $key$：关键字值，满足二叉搜索树性质
- $priority$：随机优先级，满足大根堆性质
- $size$：以该节点为根的子树大小
- $left, right$：左右子树指针

### 2.2 性质

1. **BST性质**：对于任意节点 $u$，满足：
   $$\forall v \in u.left, v.key \leq u.key$$
   $$\forall v \in u.right, v.key > u.key$$

2. **堆性质**：对于任意非叶节点 $u$，满足：
   $$u.priority > \max(u.left.priority, u.right.priority)$$

## 3. 核心操作

### 3.1 Split操作

Split操作将一棵树分裂成两棵子树，是FHQ Treap最核心的操作之一。

#### 形式化定义

给定一棵根为 $root$ 的树和关键字值 $k$，split操作返回两棵树 $(T_1, T_2)$，满足：
$$\forall v \in T_1, v.key \leq k$$
$$\forall v \in T_2, v.key > k$$

#### 算法流程

1. 若当前节点为空，返回 $(null, null)$
2. 若当前节点的 $key \leq k$：
   - 递归分裂右子树
   - 当前节点归属于左树
3. 否则：
   - 递归分裂左子树
   - 当前节点归属于右树
4. 更新子树信息

#### 示例

假设有以下树：

```
       (5,90)
      /      \
   (3,80)   (7,70)
   /    \    /   \
(2,60) (4,50) (6,40) (8,30)
```

执行 split(root, 5) 后得到：

```
左树：           右树：
   (5,90)         (7,70)
   /              /    \
(3,80)        (6,40)  (8,30)
/    \
(2,60) (4,50)
```

### 3.2 Merge操作

Merge操作将两棵树合并成一棵新树。

#### 形式化定义

给定两棵树 $T_1, T_2$，满足 $T_1$ 中所有节点的key值小于 $T_2$ 中所有节点的key值，merge操作返回一棵包含所有节点的新树。

#### 算法流程

1. 若其中一棵树为空，返回另一棵树
2. 比较两树根节点的优先级：
   - 若 $T_1.root.priority > T_2.root.priority$：
     * $T_1.root$ 作为新树的根
     * 递归合并 $T_1.right$ 和 $T_2$
   - 否则：
     * $T_2.root$ 作为新树的根
     * 递归合并 $T_1$ 和 $T_2.left$

## 4. 复杂度分析

### 4.1 期望高度

由于优先级随机生成，可以证明FHQ Treap的期望高度为 $O(\log n)$。

### 4.2 操作复杂度

- Split操作：$O(\log n)$
- Merge操作：$O(\log n)$
- 基于Split和Merge实现的其他操作（插入、删除、查询等）：$O(\log n)$

## 5. 应用场景

### 5.1 动态有序序列维护

- 支持高效的插入、删除、查询排名
- 支持区间操作

### 5.2 区间操作支持

通过两次split可以得到任意区间：

1. 第一次split得到 $\leq l-1$ 和 $\geq l$ 的两部分
2. 第二次split得到 $[l,r]$ 区间

### 5.3 可持久化支持

- 可以方便地实现可持久化
- 每次操作只需复制 $O(\log n)$ 个节点

## 6. 总结与优势

1. 实现简单，无需复杂的平衡操作
2. 随机化保证平衡性，避免最坏情况
3. 接口统一，易于扩展
4. 支持区间操作和可持久化

---

