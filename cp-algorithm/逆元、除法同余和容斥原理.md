
# 逆元的意义 & 除法同余

## 逆元和除法同余、容斥原理

当计算结果比较大时，考试、比赛时经常要求结果对一个数字取余，比如 `% 1000000007`。对于加法、乘法和减法的计算，总的来说：

- 加法和乘法，可以让每个中间结果直接取余，最后结果就是正确的。
- 减法，只需要让每个减完的结果 + MOD，然后 `% MOD`，最后结果就是正确的。

除法呢？不能这么做，比如下面的例子：

$10 / 5$，结果对3取余。正确结果是$10 / 5$得到2，$2 \% 3$得到2。但是如果中间结果直接取余，$10 \% 3$得到1，$5 \% 3$得到2，$(1 / 2) \% 3$得到0。会发现结果对不上，这是因为除法同余有比较特别的处理，**也就是除数先转化成逆元，然后让被除数乘以逆元，逆元就是倒数**的意思。

## 逆元和除法同余、容斥原理

如果你想计算：$a / b$，然后 `% MOD` 结果

1. 必须保证$a/b$可以整除，每次有除法的时候，都需要保证绝对能整除。
2. 必须保证MOD是质数，求逆元的原理是费马小定理，要求MOD是质数，比如1000000007。
3. 必须保证$b$和MOD的最大公约数为1，也就是$b$和MOD互质。

题目给定的数据一定会满足上面三点，那么就有如下的结论，直接记住，证明只需要稍微了解一下即可：

先求 $1/b$ 的乘法同余数，也就是$b$的逆元，$b$的逆元 = $b^{(MOD-2)} \% MOD$。

然后，$((a / b) \% MOD)$ 的结果，等于，$((a \% MOD) \times (b的逆元)) \% MOD$ 的结果。

比如，$(10 / 5) \% 3$，先求5的1次方 $\% 3$ = 2，$((10 \% 3) \times 2) \% 3$，结果得到2，这是正确的。

你可以假设各种例子，$a$、$b$、MOD，但要保证 : $a/b$能整除、MOD是质数、$b$和MOD互质。

## 相关数学知识补充

### 费马小定理

#### 定理阐述

费马小定理是数论中的一个重要定理，它与求解模逆元密切相关。费马小定理的表述如下：

对于一个质数 $p$ 和一个整数 $a$，如果 $a$ 不是 $p$ 的倍数，那么 $a^{p-1} \equiv 1 \pmod{p}$。

利用费马小定理，我们可以求解模 $p$ 下的逆元。具体步骤如下：

1. **确定质数 $p$**：首先，我们需要知道模数 $p$ 是一个质数。

2. **选择整数 $a$**：选择一个整数 $a$，使得 $a$ 不是 $p$ 的倍数。

3. **应用费马小定理**：根据费马小定理， $a^{p-1} \equiv 1 \pmod{p}$。

4. **求逆元**：为了求 $a$ 在模 $p$ 下的逆元，我们将上式两边同时乘以 $a^{-1}$，得到：
   $$
   a^{p-1} \cdot a^{-1} \equiv 1 \cdot a^{-1} \pmod{p}
   $$
   这简化为：
   $$
   a^{p-2} \equiv a^{-1} \pmod{p}
   $$
   因此， $a$ 在模 $p$ 下的逆元就是 $a^{p-2} \mod p$。

5. **计算 $a^{p-2} \mod p$**：使用快速幂算法（也称为二分幂算法）来高效地计算 $a^{p-2} \mod p$。

#### 示例

假设我们要找 $a = 3$ 在模 $p = 7$ 下的逆元：

1. $p = 7$ 是质数。
2. $a = 3$ 不是 7 的倍数。
3. 根据费马小定理， $3^{7-1} \equiv 1 \pmod{7}$，即 $3^6 \equiv 1 \pmod{7}$。
4. 逆元 $3^{-1} \equiv 3^5 \pmod{7}$。
5. 计算 $3^5 \mod 7$：
   $$
   3^2 = 9 \equiv 2 \pmod{7}
   $$
   $$
   3^4 = (3^2)^2 = 2^2 = 4 \pmod{7}
   $$
   $$
   3^5 = 3^4 \cdot 3 = 4 \cdot 3 = 12 \equiv 5 \pmod{7}
   $$
   因此， $3$ 在模 $7$ 下的逆元是 $5$。

#### 证明

费马小定理的证明颇为巧妙，需要使用到构造的技巧。下面就使用集合的视角来对费马小定理进行证明：

1. **定义集合**：
   - 集合 $\{1, 2, \ldots, p-1\}$ 包含 $p-1$ 个元素。
   - 集合 $\{a, 2a, \ldots, (p-1)a\}$ 也包含 $p-1$ 个元素，其中每个元素都是 $a$ 的倍数。

2. **证明集合 $\{a, 2a, \ldots, (p-1)a\}$ 在模 $p$ 下与集合 $\{1, 2, \ldots, p-1\}$ 同余**：
   - 首先，**集合 $\{a, 2a, \ldots, (p-1)a\}$ 中的每个元素 $ka$ 在模 $p$ 下都不为零，因为 $a$ 不是 $p$ 的倍数，且 $k$ 是小于 $p$ 的正整数**。
   - 其次，集合 $\{a, 2a, \ldots, (p-1)a\}$ 中的每个元素在模 $p$ 下都不同余。假设存在 $ka \equiv ma \pmod{p}$ 且 $k \neq m$，则 $(k-m)a \equiv 0 \pmod{p}$，这意味着 $p$ 整除 $(k-m)a$。由于 $p$ 是质数且 $a$ 不是 $p$ 的倍数，唯一的可能性是 $p$ 整除 $k-m$，这与 $k$ 和 $m$ 都是小于 $p$ 的正整数矛盾。

3. **乘积相等**：
   - 由于集合 $\{a, 2a, \ldots, (p-1)a\}$ 在模 $p$ 下与集合 $\{1, 2, \ldots, p-1\}$ 同余，它们的乘积也必然同余。
   - 具体来说，集合 $\{a, 2a, \ldots, (p-1)a\}$ 中的每个元素 $ka$ 在模 $p$ 下与集合 $\{1, 2, \ldots, p-1\}$ 中的某个元素 $k$ 同余。

4. **乘积的同余关系**：
   - 考虑集合 $\{a, 2a, \ldots, (p-1)a\}$ 的乘积：
 $$
     a \cdot 2a \cdot \ldots \cdot (p-1)a
     $$
   - 这个乘积可以写成： $$
     a^{p-1} \cdot (1 \cdot 2 \cdot \ldots \cdot (p-1))
     $$
   - 由于集合 $\{a, 2a, \ldots, (p-1)a\}$ 在模 $p$ 下与集合 $\{1, 2, \ldots, p-1\}$ 同余，它们的乘积也必然同余： $$
     a \cdot 2a \cdot \ldots \cdot (p-1)a \equiv 1 \cdot 2 \cdot \ldots \cdot (p-1) \pmod{p}
     $$
   - 这可以写成： $$
     a^{p-1} \cdot (p-1)! \equiv (p-1)! \pmod{p}
     $$
5. **消去 $(p-1)!$**：
   - 由于 $(p-1)!$ 在模 $p$ 下是非零的（因为 $p$ 是质数），我们可以消去 $(p-1)!$： $$
     a^{p-1} \equiv 1 \pmod{p}
     $$
#### 总结

费马小定理提供了一种在模质数 $p$ 下求解逆元的有效方法。通过计算 $a^{p-2} \mod p$，我们可以找到 $a$ 的逆元。这种方法在密码学、计算数论等领域有广泛应用。

### 逆元的线性递推

#### 连续数字逆元的线性递推

在 `% p` 意义下，

$1、2、3 ... n$，求每个数的逆元

用 `inv[i]`，代表$i$的逆元

$inv[1] = 1$

$inv[i] = (int) (p - (long) inv[p \% i] \times (p / i) \% p)$

关于数学证明，下面是我的一些手稿，仅供参考：

$$
\begin{align}
i \cdot i^{-1} &\equiv 1 \mod p \\
p \equiv (p\%i) + i \cdot \left\lfloor \frac{p}{i} \right\rfloor &\equiv 0 \mod p\\
i \cdot \left\lfloor \frac{p}{i} \right\rfloor &\equiv -(p\%i) \mod p\\
i \cdot - \left\lfloor \frac{p}{i} \right\rfloor \cdot (p\%i)^{-1} &\equiv 1 \mod p
\end{align}
$$
因此可以得到：

$$
i^{-1} = - \left\lfloor \frac{p}{i} \right\rfloor \cdot (p\%i)^{-1} \mod p
$$
如果想要最后的结果非负，那么就是直接在后面加上一个 $p$ 就可以了。

$$
i^{-1} = p - \left\lfloor \frac{p}{i} \right\rfloor \cdot (p\%i)^{-1} \mod p
$$

#### 连续阶乘逆元的线性递推

在 `% p` 意义下，

$1!、2!、3! ... n!$，求每个数的逆元，

用 `inv[i]`，代表$i!$的逆元

那么就可以从右往左线性递推得到：

$inv[n] = b$

$inv[i] = ((long) (i + 1) \times inv[i + 1]) \% MOD$

关于数学证明，其实非常简单，没有上面的那么复杂：

$$
\begin{align}
(i+1)! \ \cdot \ ((i+1)!)^{-1} &\equiv 1 \mod p\\
i! \ \cdot \ (i+1) \cdot ((i+1)!)^{-1} &\equiv 1 \mod p\\
\end{align}
$$
从上面的式子就可以很容易看出来：

$$
(i!)^{-1} = (i+1) \cdot ((i+1)!)^{-1} \mod p
$$

# 练习题目

## 题目1

给定n、p，求1∼n中所有整数在模p意义下的乘法逆元

$1 \leq n \leq 3 \times 10^6$

$n < p < 20000528$

输入保证p为质数

测试链接 : [题目链接](https://www.luogu.com.cn/problem/P3811)

时间复杂度$O(n)$

## 题目2

连续阶乘逆元的线性递推

实现组合公式$C(n,m)$的计算

最终结果 `% 1000000007` 后返回

$0 \leq m \leq n \leq 1000$

对数器验证

时间复杂度$O(n)$

## 容斥原理（相关题目）

### 定义

容斥原理（Principle of Inclusion-Exclusion）是组合数学中的一种计数技术，用于计算多个集合的并集的大小。它通过考虑每个集合的大小以及它们之间的交集来避免重复计数。

### 基本形式

对于两个集合 $A$ 和 $B$，容斥原理的基本形式是：
$$ |A \cup B| = |A| + |B| - |A \cap B| $$
其中：
- $|A|$ 表示集合 $A$ 的大小（即元素个数）。
- $|B|$ 表示集合 $B$ 的大小。
- $|A \cap B|$ 表示集合 $A$ 和 $B$ 的交集的大小。

### 推广形式

对于三个集合 $A$、$B$ 和 $C$，容斥原理的推广形式是：
$$ |A \cup B \cup C| = |A| + |B| + |C| - |A \cap B| - |A \cap C| - |B \cap C| + |A \cap B \cap C| $$

### 一般形式

对于 $n$ 个集合 $A_1, A_2, \ldots, A_n$，容斥原理的一般形式是：
$$ \left| \bigcup_{i=1}^n A_i \right| = \sum_{k=1}^n (-1)^{k+1} \left( \sum_{1 \leq i_1 < i_2 < \cdots < i_k \leq n} |A_{i_1} \cap A_{i_2} \cap \cdots \cap A_{i_k}| \right) $$
但是很多时候求解的往往是一个交集的形式，此时只需要做一个转换：**全集减去补集的并集就是要求的交集**。

### 应用

容斥原理在许多领域都有应用，例如：
- **概率论**：计算多个事件的联合概率。
- **数论**：计算满足多个条件的整数的数量。
- **组合数学**：计算满足多个条件的排列或组合的数量。

### 例子

假设我们要计算从 1 到 100 的整数中，能被 2 或 3 整除的数的个数。我们可以定义两个集合：
- $A$ 是能被 2 整除的数的集合。
- $B$ 是能被 3 整除的数的集合。

我们需要计算 $|A \cup B|$。根据容斥原理：
$$ |A \cup B| = |A| + |B| - |A \cap B| $$

其中：
- $|A|$ 是 1 到 100 中能被 2 整除的数的个数，即 $\left\lfloor \frac{100}{2} \right\rfloor = 50$。
- $|B|$ 是 1 到 100 中能被 3 整除的数的个数，即 $\left\lfloor \frac{100}{3} \right\rfloor = 33$。
- $|A \cap B|$ 是 1 到 100 中能被 6 整除的数的个数，即 $\left\lfloor \frac{100}{6} \right\rfloor = 16$。

因此：
$$ |A \cup B| = 50 + 33 - 16 = 67 $$

所以，从 1 到 100 的整数中，能被 2 或 3 整除的数的个数是 67。

容斥原理是一个非常强大的工具，能够帮助我们解决许多复杂的计数问题。


有关题目可不容易，==核心是如何设计出快速查询若干集合交集数量的问答系统==，常见的题型有两类

1. 打表查询（题目4、题目5）
2. 不用查询直接公式化简（题目6）

### 题目4

最大公约数为1的子序列数量

给你一个数组，返回有多少个子序列的最大公约数是1

结果可能很大对1000000007取模

测试链接 : [题目链接](https://www.luogu.com.cn/problem/CF803F)

$1 \leq n \leq 10^5$

$1 \leq nums[i] \leq 10^5$

### 扩展问题

最大公约数为k的子序列数量

给定一个长度为n的正数数组nums，还有正数k

返回有多少子序列的最大公约数为k

### 题目5

多次查询购买方法

一共有4种硬币，面值分别为$v0$、$v1$、$v2$、$v3$，这个永远是确定的

每次去购物的细节由一个数组arr来表示，每次购物都是一次查询

$arr[0] = 携带v0面值的硬币数量$

$arr[1] = 携带v1面值的硬币数量$

$arr[2] = 携带v2面值的硬币数量$

$arr[3] = 携带v3面值的硬币数量$

$arr[4] = 本次购物一定要花多少钱$

返回每次有多少种花钱的方法

$1 \leq v0、v1、v2、v3、arr[i] \leq 10^5$

查询数量 <= 1000

测试链接 : [洛谷P1450](https://www.luogu.com.cn/problem/P1450)

### 题目6

播放列表的数量

给定三个参数，n、l、k

你的音乐播放器里有n首不同的歌

在旅途中你的旅伴想要听l首歌

听得歌曲不一定不同，即允许歌曲重复

请你为她按如下两条规则创建一个播放列表

1. 每首歌至少播放一次
2. 一首歌只有在其他k首歌播放完之后才能再次播放

返回可以满足要求的播放列表的数量

结果可能很大对1000000007取模

测试链接 : [力扣-播放列表的数量](https://leetcode.cn/problems/number-of-music-playlists/)
