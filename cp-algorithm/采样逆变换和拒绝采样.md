# 采样逆变换原理

采样逆变换原理（Inverse Transform Sampling 或 Inversion Method）是一种从任意概率分布中生成随机样本的方法，前提是已知该分布的**累积分布函数 (Cumulative Distribution Function, CDF)** 并能够计算其**反函数**。

## 核心思想

如果有一个随机变量 $X$，其累积分布函数为 $F_X(x) = P(X \leq x)$，$F_X(x)$ 的值域是 $[0, 1]$。

采样逆变换法的核心在于：

**如果 $U$ 是一个在 $[0, 1]$ 区间上均匀分布的随机变量 (即 $U \sim \text{Uniform}(0,1)$), 那么随机变量 $X = F_X^{-1}(U)$（其中 $F_X^{-1}$ 是 $F_X$ 的反函数）将具有 $F_X$ 这个累积分布函数，即 $X$ 的分布与期望的分布相同。**

## 原理证明

### CDF 的特性

- $F_X(x)$ 是一个非递减函数
- 当 $x$ 从负无穷到正无穷变化时，$F_X(x)$ 从 0 变化到 1

### 连接均匀分布和目标分布

希望生成的样本 $X$ 满足 $P(X \leq x) = F_X(x)$。

考虑通过 $X = F_X^{-1}(U)$ 生成的 $X$，其累积分布函数 $P(X \leq x)$ 可推导如下：

$$P(X \leq x) = P(F_X^{-1}(U) \leq x)$$

因为 $F_X(x)$ 是非递减的（假设它是严格递增的，使反函数唯一确定；对于非严格递增情况，需使用广义反函数），可对不等式两边同时应用 $F_X$ 函数：

$$P(F_X(F_X^{-1}(U)) \leq F_X(x))$$

由于 $F_X$ 和 $F_X^{-1}$ 互为反函数，$F_X(F_X^{-1}(U)) = U$。因此：

$$P(U \leq F_X(x))$$

由于 $U$ 在 $[0, 1]$ 上均匀分布，对于任何 $0 \leq y \leq 1$，有 $P(U \leq y) = y$。

令 $y = F_X(x)$，得到：

$$P(U \leq F_X(x)) = F_X(x)$$

因此，$P(X \leq x) = F_X(x)$，证明了通过 $X = F_X^{-1}(U)$ 生成的随机变量 $X$ 确实具有期望的累积分布函数 $F_X(x)$。

## 实施步骤

1. **确定目标概率分布的累积分布函数 (CDF)** $F_X(x)$
    
    - 如果概率密度函数 (PDF) 是 $f_X(t)$，则 $F_X(x) = \int_{-\infty}^{x} f_X(t) dt$
2. **求 CDF 的反函数** $F_X^{-1}(u)$
    
    - 通过解方程 $u = F_X(x)$ 得到 $x$ 关于 $u$ 的表达式，即 $x = F_X^{-1}(u)$
3. **生成服从 $\text{Uniform}(0,1)$ 分布的随机数 $u$**
    
    - 大多数编程语言都有内置函数生成这种随机数
4. **计算 $x = F_X^{-1}(u)$**
    
    - 这个 $x$ 就是从目标分布中抽取的一个样本

## 圆内均匀采样问题分析

在圆内均匀采样时，希望一个点落在半径为 $r_{sample}$ 的圆盘内的概率与该圆盘的面积成正比。

设圆的总半径为 $R$：

- 半径为 $r_{sample}$ 的圆盘面积：$A(r_{sample}) = \pi \cdot r_{sample}^2$
- 总圆盘面积：$A(R) = \pi \cdot R^2$

选取的半径 $R_s$ (采样半径) 的累积分布函数 $F(r)$ 应满足：

$$F(r) = P(R_s \leq r) = \frac{A(r)}{A(R)} = \frac{\pi \cdot r^2}{\pi \cdot R^2} = \left(\frac{r}{R}\right)^2$$

其中 $0 \leq r \leq R$。

应用逆变换采样：

1. **CDF**: $F(r) = \left(\frac{r}{R}\right)^2$
2. **求反函数**: 设 $u = F(r)$，即 $u = \left(\frac{r}{R}\right)^2$
    - 解得：$\sqrt{u} = \frac{r}{R}$
    - 因此：$r = R \cdot \sqrt{u}$
    - 所以，$F^{-1}(u) = R \cdot \sqrt{u}$
3. **生成 $u \sim \text{Uniform}(0,1)$**
4. **计算采样半径**: $radius_{sample} = R \cdot \sqrt{u}$

## 经典示例：生成指数分布的随机数

指数分布的概率密度函数 (PDF) 是 $f(x; \lambda) = \lambda \cdot e^{-\lambda x}$，其中 $x \geq 0$。

1. **CDF**: $$F(x) = \int_0^x \lambda \cdot e^{-\lambda t} dt = [-e^{-\lambda t}]_0^x = 1 - e^{-\lambda x}$$
    
2. **反函数**:
    
    - 设 $u = 1 - e^{-\lambda x}$
    - 解得：$e^{-\lambda x} = 1 - u$
    - 进一步：$-\lambda x = \ln(1 - u)$
    - 因此：$x = -\frac{\ln(1 - u)}{\lambda}$
    - 所以 $F^{-1}(u) = -\frac{\ln(1 - u)}{\lambda}$
    
    注：因为 $u$ 是 $\text{Uniform}(0,1)$，所以 $1-u$ 也是 $\text{Uniform}(0,1)$。因此，也可直接使用 $x = -\frac{\ln(u)}{\lambda}$，效果相同。
    
3. **生成 $u \sim \text{Uniform}(0,1)$**
    
4. **计算 $x = -\frac{\ln(1 - u)}{\lambda}$ 或 $x = -\frac{\ln(u)}{\lambda}$**
    

## 优缺点

### 优点

- **精确性**：如果 CDF 及其反函数可以精确计算，则此方法可以精确生成符合目标分布的样本
- **高效性**：通常只需要生成一个均匀随机数和一次函数求值

### 缺点

- **前提条件**：需要知道 CDF 并能求出其反函数的解析形式。对于某些复杂的分布，这可能很困难或不可能。例如，正态分布的 CDF 没有简单的解析反函数（需要用到误差函数的反函数）

## 总结

采样逆变换原理是一种强大而基础的随机数生成技术，它将生成任意分布样本的问题转化为计算其 CDF 反函数的问题。对于那些 CDF 具有解析反函数的分布，这是一种简单高效的方法。

---
# 拒绝采样原理

拒绝采样（Rejection Sampling）是一种从复杂概率分布中生成随机样本的方法，**特别适用于直接采样困难或累积分布函数(CDF)的反函数难以计算的情况**。

## 核心思想

拒绝采样的基本思想是：

1. 从一个简单的分布（称为**提议分布**或**建议分布**）中生成样本
2. 根据一定的概率规则**接受或拒绝**这些样本
3. 被接受的样本将服从目标分布

## 算法步骤

假设我们希望从目标分布 $f(x)$ 中采样，而我们有一个易于采样的提议分布 $g(x)$。

1. 找到一个常数 $M$，使得 $f(x) \leq M \cdot g(x)$ 对所有 $x$ 成立
2. 从提议分布 $g(x)$ 中生成一个样本 $x$
3. 生成一个均匀分布的随机数 $u \sim \text{Uniform}(0,1)$
4. 如果 $u \leq \frac{f(x)}{M \cdot g(x)}$，则接受样本 $x$；否则拒绝
5. 重复步骤 2-4 直到获得所需数量的样本

## 理论依据

当我们接受样本 $x$ 的条件是 $u \leq \frac{f(x)}{M \cdot g(x)}$ 时，被接受的样本 $x$ 的概率密度函数实际上就是 $f(x)$。

这可以通过条件概率来证明：被接受的样本 $x$ 的分布是 $g(x)$ 条件于接受事件的条件分布。设 $A$ 表示接受事件，则：

$$P(x|A) = \frac{P(A|x) \cdot g(x)}{P(A)}$$

其中：

- $P(A|x) = \frac{f(x)}{M \cdot g(x)}$ 是给定 $x$ 时接受的概率
- $g(x)$ 是提议分布的密度函数
- $P(A) = \int P(A|x) \cdot g(x) dx = \frac{1}{M} \int f(x) dx = \frac{1}{M}$ 是总体接受率

因此：

$$P(x|A) = \frac{\frac{f(x)}{M \cdot g(x)} \cdot g(x)}{\frac{1}{M}} = f(x)$$

这证明了被接受的样本确实服从目标分布 $f(x)$。

## 圆内均匀采样问题

对于在圆内均匀采样的问题，我们可以使用拒绝采样方法：

1. **目标分布**：圆内的均匀分布
2. **提议分布**：包围圆的正方形内的均匀分布

### 具体步骤

假设我们要在半径为 $R$ 的圆内均匀采样：

1. 在边长为 $2R$ 的正方形 $[-R, R] \times [-R, R]$ 内均匀采样点 $(x, y)$
2. 检查点 $(x, y)$ 是否在圆内，即是否满足 $x^2 + y^2 \leq R^2$
3. 如果在圆内，则接受该点；否则拒绝并重新采样

### 效率分析

在这个问题中，接受率等于圆的面积与正方形面积之比：

$$\text{接受率} = \frac{\pi R^2}{(2R)^2} = \frac{\pi}{4} \approx 0.785$$

这意味着大约 78.5% 的样本会被接受，21.5% 会被拒绝。

### 代码实现示例

```python
def sample_point_in_circle(radius):
    while True:
        # 在正方形内均匀采样
        x = random.uniform(-radius, radius)
        y = random.uniform(-radius, radius)
        
        # 检查点是否在圆内
        if x*x + y*y <= radius*radius:
            return (x, y)
```

## 拒绝采样的优缺点

### 优点

- **适用性广**：可以用于采样任何已知概率密度函数的分布
- **实现简单**：概念直观，易于理解和实现
- **不要求知道目标分布的归一化常数**：只需要知道分布的形状

### 缺点

- **效率问题**：如果接受率低，可能需要生成大量样本才能获得足够的接受样本
- **选择合适的提议分布和常数 $M$ 可能困难**：提议分布应该尽可能接近目标分布，以提高效率
- **维度灾难**：在高维空间中，接受率可能非常低，导致算法效率极低

## 应用场景

拒绝采样在以下情况特别有用：

- 目标分布的 CDF 难于计算或求逆
- 目标分布有复杂的约束条件
- 需要从截断分布中采样
- 目标分布是混合分布或多峰分布

---
# 采样逆变换与拒绝采样方法比较

## 两种方法的对比

|特性|采样逆变换法|拒绝采样法|
|---|---|---|
|**核心思想**|将均匀分布的样本通过 CDF 的反函数映射到目标分布|从简单分布中采样，按一定概率接受或拒绝样本|
|**要求**|需要知道 CDF 及其反函数|需要一个易于采样的提议分布和一个有界的比例因子|
|**效率**|每个生成的样本都被接受，效率高|部分样本被拒绝，效率取决于接受率|
|**适用性**|适用于 CDF 反函数易于计算的分布|适用范围更广，不要求知道 CDF 或其反函数|
|**计算复杂度**|通常只需要生成一个随机数和一次函数求值|可能需要多次尝试才能获得一个有效样本|
|**维度扩展性**|在高维情况下仍然有效|在高维空间中接受率可能非常低，效率降低|
|**实现难度**|如果 CDF 反函数难以计算，实现可能复杂|概念简单，实现通常较为直观|

## 圆内均匀采样问题上的比较

### 采样逆变换法解决圆内均匀采样

- **思路**：将半径的分布通过 CDF 分析转换为 $r = R \cdot \sqrt{u}$，角度均匀分布
- **步骤**：
    1. 生成 $u \sim \text{Uniform}(0,1)$
    2. 计算半径 $r = R \cdot \sqrt{u}$
    3. 生成角度 $\theta \sim \text{Uniform}(0, 2\pi)$
    4. 转换为笛卡尔坐标 $(r\cos\theta, r\sin\theta)$
- **效率**：每次生成的点都是有效的，接受率 100%

### 拒绝采样法解决圆内均匀采样

- **思路**：在包围圆的正方形内均匀采样，仅接受落在圆内的点
- **步骤**：
    1. 在 $[-R, R] \times [-R, R]$ 正方形内均匀采样点 $(x, y)$
    2. 检查 $x^2 + y^2 \leq R^2$，满足则接受，否则拒绝
- **效率**：接受率约为 $1 - \pi/4 \approx 0.785$

## 选择指南：何时使用哪种方法

### 适合使用采样逆变换法的情况

- **CDF 反函数易于计算时**：如指数分布、幂律分布等
- **需要高效率采样时**：每个样本都被接受，没有浪费
- **在高维空间中采样时**：不会因维度增加而效率显著下降
- **需要对样本进行确定性控制时**：可以通过控制输入的均匀分布样本实现
- **样本质量要求高时**：采样逆变换法生成的样本通常更准确地反映了目标分布

### 适合使用拒绝采样法的情况

- **CDF 难以计算或求逆时**：如复杂的多峰分布
- **分布有复杂约束条件时**：如受限区域内的分布
- **只知道概率密度函数的非标准化形式时**：不需要知道归一化常数
- **目标分布为混合分布或条件分布时**
- **实现简单性优先于效率时**：概念更直观易于实现

## 实际应用建议

1. **先尝试采样逆变换法**：如果目标分布的 CDF 反函数容易计算，采样逆变换法通常是最优选择
    
2. **退而求其次用拒绝采样法**：当 CDF 反函数难以计算或分布形式复杂时，考虑使用拒绝采样法
    
3. **混合使用**：有时将两种方法结合使用效果最佳，例如：
    
    - 使用采样逆变换法生成提议分布的样本
    - 然后通过拒绝采样法将这些样本转换为目标分布的样本
4. **效率考量**：
    
    - 如果拒绝采样的接受率非常低（如低于 10%），考虑其他方法如重要性采样或马尔可夫链蒙特卡洛
    - 在高维问题中，尽量避免使用拒绝采样，除非有特别高效的提议分布
5. **对于圆内均匀采样**：虽然两种方法都可行，但采样逆变换法效率更高，且实现同样简单，因此是首选方法
    

总之，方法的选择应根据具体问题、计算资源和实现难度综合考虑。在实际应用中，深入理解这两种基本采样方法的原理将有助于开发更复杂的采样算法和解决更具挑战性的问题。